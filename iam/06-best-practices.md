# 第六层：最佳实践 (Best Practices) - 深度展开

## 1. 从第一性原理看安全

### 1.1 安全的本质矛盾

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  安全性 ◄─────────────────────────────► 便利性         │
│                                                         │
│  极致安全                              极致便利         │
│  ──────────                           ──────────        │
│  - 什么都不能做                       - 什么都能做      │
│  - 每步都要审批                       - 无需任何验证    │
│  - 业务停滞                           - 随时被攻破      │
│                                                         │
│  IAM 最佳实践的目标：                                   │
│  在可接受的便利性损失下，最大化安全性                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 1.2 安全的三个假设

```
假设1：攻击必然发生
─────────────────────
不是"会不会被攻击"，而是"什么时候被攻击"
设计时要考虑：被攻破后如何最小化损失

假设2：内部也不可信
─────────────────────
员工可能被钓鱼
凭证可能被泄露
机器可能被入侵
不能因为"在内网"就放松警惕

假设3：复杂性是敌人
─────────────────────
权限越复杂，越容易出错
规则越多，越难审计
配置越乱，越容易有漏洞
```

---

## 2. 最小权限原则 (Least Privilege)

### 2.1 核心思想

```
只授予完成工作所需的最小权限，不多一分

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  错误思维："给他 Admin 权限吧，省得以后再加"            │
│                                                         │
│  正确思维：                                             │
│    1. 这个任务需要做什么操作？                          │
│    2. 操作哪些具体资源？                                │
│    3. 在什么条件下需要？                                │
│    4. 只给这些，不多给                                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.2 实施步骤

```
Step 1: 从零开始
─────────────────
新建的 User/Role 默认没有任何权限
这是正确的起点

Step 2: 按需添加
─────────────────
遇到 Access Denied？
  → 分析需要什么权限
  → 只添加那个权限
  → 不要图省事加 *

Step 3: 定期审查
─────────────────
每季度 review：
  - 这个权限还需要吗？
  - 有没有从未使用的权限？
  - 能不能进一步收窄？

Step 4: 自动化检测
─────────────────
使用工具发现过度权限：
  - AWS IAM Access Analyzer
  - 自定义脚本分析 CloudTrail
```

### 2.3 实际示例

```json
// ❌ 错误：过度宽泛
{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "*"
}

// ❌ 稍好但仍不够
{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "arn:aws:s3:::my-bucket/*"
}

// ✅ 正确：精确控制
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject"
  ],
  "Resource": "arn:aws:s3:::my-bucket/uploads/${aws:userid}/*"
}
// 只能读写自己目录下的文件
```

### 2.4 使用 IAM Access Analyzer

```bash
# 分析未使用的权限
aws accessanalyzer generate-policy-from-access-activity \
    --policy-generation-details '{
        "principalArn": "arn:aws:iam::123456789012:role/MyRole"
    }'

# 输出示例：
{
  "generatedPolicyResult": {
    "generatedPolicies": [
      {
        "policy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Resource": [
                "arn:aws:s3:::prod-data",
                "arn:aws:s3:::prod-data/*"
              ]
            }
          ]
        }
      }
    ]
  }
}
// 根据实际 API 调用历史生成最小权限策略
```

### 2.5 权限收紧策略

```
场景：从过度权限迁移到最小权限

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  阶段1：审计模式                                        │
│  ─────────────────                                      │
│  保持现有权限                                           │
│  开启详细日志记录                                       │
│  收集 30-90 天的 API 调用数据                          │
│                                                         │
│  阶段2：分析生成                                        │
│  ─────────────────                                      │
│  用 Access Analyzer 生成最小权限策略                   │
│  人工 review 确认没有遗漏                               │
│                                                         │
│  阶段3：并行测试                                        │
│  ─────────────────                                      │
│  创建新策略，附加到测试角色                             │
│  在非生产环境验证功能                                   │
│                                                         │
│  阶段4：灰度切换                                        │
│  ─────────────────                                      │
│  先对部分身份应用新策略                                 │
│  监控是否有 Access Denied                              │
│  逐步扩大范围                                           │
│                                                         │
│  阶段5：清理旧权限                                      │
│  ─────────────────                                      │
│  移除过度的旧策略                                       │
│  保留审计日志备查                                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 零信任原则 (Zero Trust)

### 3.1 核心思想

```
永不信任，始终验证 (Never Trust, Always Verify)

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  传统模型：城堡与护城河                                 │
│  ─────────────────────────                              │
│                                                         │
│         外部（不信任）                                  │
│              │                                          │
│              ▼                                          │
│      ┌───────────────┐                                 │
│      │   防火墙       │                                 │
│      └───────────────┘                                 │
│              │                                          │
│              ▼                                          │
│         内部（信任）                                    │
│                                                         │
│  问题：一旦攻入内部，可以横向移动                       │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  零信任模型：没有内外之分                               │
│  ─────────────────────────                              │
│                                                         │
│      ┌─────┐    ┌─────┐    ┌─────┐                    │
│      │ 服务 │◄──►│ 服务 │◄──►│ 服务 │                    │
│      │  A   │    │  B   │    │  C   │                    │
│      └─────┘    └─────┘    └─────┘                    │
│         │          │          │                         │
│         └──────────┴──────────┘                         │
│                    │                                    │
│        每次访问都要验证身份和权限                       │
│        不因为"在内网"就信任                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 零信任的五大支柱

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  1. 身份验证 (Identity)                                │
│     每次请求都验证身份                                  │
│     不依赖网络位置判断信任                              │
│                                                         │
│  2. 设备验证 (Device)                                  │
│     设备是否合规？                                      │
│     是否已知设备？                                      │
│                                                         │
│  3. 网络微分段 (Network)                               │
│     最小化网络暴露面                                    │
│     服务间通信加密                                      │
│                                                         │
│  4. 应用安全 (Application)                             │
│     应用层面的访问控制                                  │
│     API 级别的权限检查                                  │
│                                                         │
│  5. 数据保护 (Data)                                    │
│     数据分类和标签                                      │
│     加密和访问控制                                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 IAM 中的零信任实践

```
实践1：使用临时凭证
─────────────────────
❌ 长期 Access Key
✅ AssumeRole 获取临时凭证
✅ OIDC Federation

每次访问都重新验证，凭证有时效


实践2：条件限制
─────────────────────
不只是"谁能做什么"，还要"在什么条件下"

{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "*",
  "Condition": {
    "IpAddress": {"aws:SourceIp": "10.0.0.0/8"},
    "Bool": {"aws:MultiFactorAuthPresent": "true"},
    "DateGreaterThan": {"aws:CurrentTime": "2024-01-01T09:00:00Z"},
    "DateLessThan": {"aws:CurrentTime": "2024-01-01T18:00:00Z"}
  }
}
// 只有从内网、用 MFA、在工作时间才允许


实践3：服务间认证
─────────────────────
服务 A 调用服务 B，也需要认证

┌─────────┐                ┌─────────┐
│Service A│                │Service B│
│         │  1. 用自己的   │         │
│         │     Role 凭证  │         │
│         │───────────────►│         │
│         │                │ 2. 验证 │
│         │                │    调用者│
│         │◄───────────────│    身份 │
│         │  3. 返回结果   │         │
└─────────┘                └─────────┘

不因为是"内部服务"就跳过认证


实践4：持续评估
─────────────────────
不是一次验证就永久信任
而是持续监控和重新评估

- Session 有过期时间
- 异常行为触发重新认证
- 风险评分影响访问决策
```

---

## 4. 职责分离 (Separation of Duties)

### 4.1 核心思想

```
敏感操作需要多人/多角色配合，防止单点滥用

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  场景：数据库管理                                       │
│                                                         │
│  ❌ 错误：DBA 有所有权限                               │
│     - 可以看数据                                        │
│     - 可以改数据                                        │
│     - 可以删数据                                        │
│     - 可以导出数据                                      │
│     → 一人作恶，无人知晓                                │
│                                                         │
│  ✅ 正确：权限分离                                      │
│     DBA-Schema: 可以改表结构，不能看数据               │
│     DBA-Backup: 可以备份恢复，不能直接访问             │
│     Auditor:    可以看日志，不能改任何东西             │
│     → 相互制约，操作可追溯                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 常见分离模式

```
模式1：开发与生产分离
─────────────────────
开发者：
  ✅ 完全控制开发环境
  ✅ 只读访问生产日志
  ❌ 不能直接访问生产数据库
  ❌ 不能直接部署到生产

部署由 CI/CD 自动完成，需要 code review 才能 merge


模式2：创建与使用分离
─────────────────────
管理员：
  ✅ 可以创建 IAM Role
  ❌ 不能 Assume 这些 Role

使用者：
  ✅ 可以 Assume 分配的 Role
  ❌ 不能创建或修改 Role


模式3：密钥管理分离
─────────────────────
密钥管理员：
  ✅ 可以创建/轮换密钥
  ❌ 不能使用密钥加解密

应用：
  ✅ 可以使用密钥加解密
  ❌ 不能管理密钥本身


模式4：审计独立
─────────────────────
审计员：
  ✅ 只读访问所有日志
  ✅ 可以生成合规报告
  ❌ 不能修改任何资源
  ❌ 不能删除日志

关键：审计员不受其他管理员管理
```

### 4.3 实现示例：双人控制

```json
// 敏感操作需要两个不同角色配合

// Role: RequestApprover - 可以创建请求
{
  "Effect": "Allow",
  "Action": [
    "ec2:CreateTerminateInstanceRequest"  // 假设的 API
  ],
  "Resource": "*"
}

// Role: RequestExecutor - 可以执行已批准的请求
{
  "Effect": "Allow",
  "Action": [
    "ec2:ExecuteApprovedRequest"
  ],
  "Resource": "*",
  "Condition": {
    "StringNotEquals": {
      "aws:userid": "${ec2:RequestCreator}"  // 不能自己批准自己
    }
  }
}

// 实际中可以用 AWS Organizations SCP + Step Functions 实现
```

---

## 5. 审计与监控

### 5.1 为什么审计如此重要

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  没有审计的权限系统 = 没有摄像头的银行金库              │
│                                                         │
│  审计的三大作用：                                       │
│                                                         │
│  1. 威慑                                                │
│     知道被记录，减少内部滥用                            │
│                                                         │
│  2. 检测                                                │
│     发现异常行为和潜在攻击                              │
│                                                         │
│  3. 取证                                                │
│     安全事件后可以追溯                                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 CloudTrail 配置

```bash
# 创建 Trail，记录所有 API 调用
aws cloudtrail create-trail \
    --name my-trail \
    --s3-bucket-name my-audit-bucket \
    --is-multi-region-trail \
    --include-global-service-events \
    --enable-log-file-validation

# 启用 Trail
aws cloudtrail start-logging --name my-trail
```

**CloudTrail 日志示例：**

```json
{
  "eventVersion": "1.08",
  "userIdentity": {
    "type": "AssumedRole",
    "principalId": "AROA3XFRBF535:alice-session",
    "arn": "arn:aws:sts::123456789012:assumed-role/AdminRole/alice-session",
    "accountId": "123456789012",
    "sessionContext": {
      "sessionIssuer": {
        "type": "Role",
        "principalId": "AROA3XFRBF535",
        "arn": "arn:aws:iam::123456789012:role/AdminRole",
        "accountId": "123456789012",
        "userName": "AdminRole"
      },
      "attributes": {
        "creationDate": "2024-01-15T10:30:00Z",
        "mfaAuthenticated": "true"
      }
    }
  },
  "eventTime": "2024-01-15T10:35:00Z",
  "eventSource": "s3.amazonaws.com",
  "eventName": "DeleteObject",
  "awsRegion": "us-east-1",
  "sourceIPAddress": "203.0.113.50",
  "userAgent": "aws-cli/2.0.0",
  "requestParameters": {
    "bucketName": "prod-data",
    "key": "important-file.txt"
  },
  "responseElements": null,
  "requestID": "abc123",
  "eventID": "def456"
}
```

### 5.3 关键监控指标

```
┌─────────────────────────────────────────────────────────┐
│                   IAM 安全监控指标                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  身份相关：                                             │
│  ─────────                                              │
│  - Root 账号登录（应该为 0）                            │
│  - IAM User 创建/删除                                   │
│  - Access Key 创建/使用                                 │
│  - 密码/MFA 变更                                        │
│                                                         │
│  权限相关：                                             │
│  ─────────                                              │
│  - Policy 变更                                          │
│  - Role Trust Policy 变更                              │
│  - Permission Boundary 变更                            │
│  - 敏感权限使用（iam:*, organizations:*）              │
│                                                         │
│  异常行为：                                             │
│  ─────────                                              │
│  - 非常规时间的 API 调用                                │
│  - 非常规地理位置的访问                                 │
│  - 大量 Access Denied（可能是攻击探测）                │
│  - 首次使用的 API（可能是凭证被盗）                    │
│                                                         │
│  凭证相关：                                             │
│  ─────────                                              │
│  - AssumeRole 调用                                     │
│  - 跨账号访问                                           │
│  - 联邦身份认证                                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.4 告警规则示例

```python
# CloudWatch Metric Filter + Alarm

# 规则1：Root 账号使用告警
{
    "filterName": "RootAccountUsage",
    "filterPattern": '{ $.userIdentity.type = "Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != "AwsServiceEvent" }',
    "metricTransformations": [{
        "metricName": "RootAccountUsageCount",
        "metricNamespace": "IAMSecurity",
        "metricValue": "1"
    }]
}
# 告警阈值：> 0


# 规则2：IAM Policy 变更告警
{
    "filterName": "IAMPolicyChanges",
    "filterPattern": '{ ($.eventName = CreatePolicy) || ($.eventName = DeletePolicy) || ($.eventName = CreatePolicyVersion) || ($.eventName = DeletePolicyVersion) || ($.eventName = AttachRolePolicy) || ($.eventName = DetachRolePolicy) || ($.eventName = AttachUserPolicy) || ($.eventName = DetachUserPolicy) }',
    "metricTransformations": [{
        "metricName": "IAMPolicyChangeCount",
        "metricNamespace": "IAMSecurity",
        "metricValue": "1"
    }]
}
# 告警阈值：根据正常变更频率设定


# 规则3：Access Key 泄露检测（异常使用模式）
{
    "filterName": "AccessKeyAnomalousUsage",
    "filterPattern": '{ $.userIdentity.type = "IAMUser" && $.sourceIPAddress != "10.*" }',
    # 进一步分析：
    # - 从未见过的 IP
    # - 非工作时间
    # - 调用从未使用的 API
}
```

### 5.5 安全事件响应

```
┌─────────────────────────────────────────────────────────┐
│                  凭证泄露响应流程                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  阶段1：检测（Detection）                              │
│  ─────────────────────                                  │
│  - CloudTrail 告警触发                                 │
│  - 或外部报告（如 GitHub 扫描到 Key）                  │
│                                                         │
│  阶段2：遏制（Containment）                            │
│  ─────────────────────                                  │
│  立即行动（分钟级）：                                   │
│  1. 禁用泄露的 Access Key                              │
│     aws iam update-access-key --status Inactive        │
│  2. 撤销所有活跃 Session                               │
│     aws iam attach-role-policy --policy deny-all       │
│  3. 阻止可疑 IP                                        │
│                                                         │
│  阶段3：调查（Investigation）                          │
│  ─────────────────────                                  │
│  分析 CloudTrail：                                     │
│  - 泄露的 Key 做了什么？                               │
│  - 访问了哪些资源？                                    │
│  - 创建了什么后门（新 User、Key、Role）？              │
│  - 数据是否被导出？                                    │
│                                                         │
│  阶段4：清除（Eradication）                            │
│  ─────────────────────                                  │
│  删除攻击者创建的：                                     │
│  - IAM User、Role、Policy                              │
│  - Access Key                                          │
│  - EC2 实例、Lambda 函数等                             │
│                                                         │
│  阶段5：恢复（Recovery）                               │
│  ─────────────────────                                  │
│  - 创建新的 Access Key（如果需要）                     │
│  - 恢复正常权限                                        │
│  - 验证系统正常运行                                    │
│                                                         │
│  阶段6：总结（Lessons Learned）                        │
│  ─────────────────────                                  │
│  - 为什么泄露？                                        │
│  - 如何防止再次发生？                                  │
│  - 检测能否更快？                                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 6. 多账号架构最佳实践

### 6.1 为什么要多账号

```
单账号的问题：

┌─────────────────────────────────────────────────────────┐
│                     单一 AWS 账号                       │
│                                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │
│  │   Dev   │ │ Staging │ │  Prod   │ │ Finance │      │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │
│                                                         │
│  问题：                                                 │
│  - 权限边界模糊                                        │
│  - 一个环境的问题可能影响其他                          │
│  - 成本难以分摊                                        │
│  - 审计日志混杂                                        │
│  - 达到服务配额影响全局                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 推荐的多账号结构

```
┌─────────────────────────────────────────────────────────────────┐
│                      AWS Organization                           │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    Management Account                      │ │
│  │                    (仅用于组织管理)                         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐            │
│         │                    │                    │            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐    │
│  │  Security   │      │    Log      │      │   Shared    │    │
│  │    OU       │      │    OU       │      │ Services OU │    │
│  ├─────────────┤      ├─────────────┤      ├─────────────┤    │
│  │ - Audit     │      │ - Log       │      │ - Network   │    │
│  │ - Security  │      │   Archive   │      │ - DNS       │    │
│  │   Tooling   │      │             │      │ - Shared    │    │
│  └─────────────┘      └─────────────┘      └─────────────┘    │
│                                                                 │
│         ┌────────────────────┼────────────────────┐            │
│         │                    │                    │            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐    │
│  │ Development │      │   Staging   │      │ Production  │    │
│  │     OU      │      │     OU      │      │     OU      │    │
│  ├─────────────┤      ├─────────────┤      ├─────────────┤    │
│  │ - Team A    │      │ - Staging   │      │ - Prod A    │    │
│  │ - Team B    │      │             │      │ - Prod B    │    │
│  │ - Sandbox   │      │             │      │             │    │
│  └─────────────┘      └─────────────┘      └─────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 Service Control Policies (SCP)

```json
// SCP：组织层面的权限天花板

// 示例1：禁止离开组织
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": [
        "organizations:LeaveOrganization"
      ],
      "Resource": "*"
    }
  ]
}

// 示例2：限制可用区域
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "aws:RequestedRegion": [
            "us-east-1",
            "us-west-2",
            "eu-west-1"
          ]
        }
      }
    }
  ]
}

// 示例3：强制使用 IMDSv2（EC2 元数据安全）
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "ec2:RunInstances",
      "Resource": "arn:aws:ec2:*:*:instance/*",
      "Condition": {
        "StringNotEquals": {
          "ec2:MetadataHttpTokens": "required"
        }
      }
    }
  ]
}
```

### 6.4 跨账号访问模式

```
┌─────────────────────────────────────────────────────────────────┐
│                      集中式身份管理                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Identity Account                       │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │              IAM Identity Center                  │   │   │
│  │  │              (AWS SSO)                           │   │   │
│  │  │                                                   │   │   │
│  │  │   - 集中管理用户和组                             │   │   │
│  │  │   - Permission Sets                              │   │   │
│  │  │   - 自动在各账号创建 Role                        │   │   │
│  │  │                                                   │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│              ┌───────────────┼───────────────┐                 │
│              │               │               │                 │
│              ▼               ▼               ▼                 │
│       ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│       │   Dev    │    │ Staging  │    │   Prod   │            │
│       │ Account  │    │ Account  │    │ Account  │            │
│       │          │    │          │    │          │            │
│       │ Role:    │    │ Role:    │    │ Role:    │            │
│       │ DevAdmin │    │ StgAdmin │    │ ProdRead │            │
│       │          │    │          │    │ ProdAdmin│            │
│       └──────────┘    └──────────┘    └──────────┘            │
│                                                                 │
│  用户通过 SSO Portal 选择账号和角色，自动 AssumeRole           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 安全清单

### 7.1 账号级别

```
□ 启用 MFA 保护 Root 账号
□ 不使用 Root 账号进行日常操作
□ 删除 Root 账号的 Access Key
□ 启用 CloudTrail（所有区域）
□ 配置 CloudTrail 日志的 S3 存储桶策略（防删除）
□ 启用 GuardDuty（威胁检测）
□ 配置账单告警
□ 启用 Config（配置合规检查）
```

### 7.2 身份级别

```
□ 优先使用 IAM Role 而非 IAM User
□ 对人类用户强制 MFA
□ 定期轮换 Access Key（如果必须使用）
□ 删除未使用的用户和凭证
□ 使用 IAM Identity Center（SSO）管理人员访问
□ 为服务账号使用独立的 Role
□ 设置密码策略（长度、复杂度、过期）
```

### 7.3 权限级别

```
□ 遵循最小权限原则
□ 使用 Permission Boundary 限制委托权限
□ 定期审查权限（使用 Access Analyzer）
□ 避免使用 * 通配符（Action 和 Resource）
□ 为敏感操作添加 Condition（MFA、IP、时间）
□ 使用 SCP 设置组织级别的权限边界
□ 文档化权限矩阵
```

### 7.4 监控级别

```
□ 配置关键事件告警（Root 登录、Policy 变更等）
□ 定期审查 CloudTrail 日志
□ 监控异常登录行为
□ 设置 Access Denied 事件告警（可能是攻击探测）
□ 保留日志至少 1 年（合规要求可能更长）
□ 日志存储桶启用 MFA Delete 保护
```

---

## 8. 总结

```
┌─────────────────────────────────────────────────────────────────┐
│                       IAM 最佳实践总结                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  核心原则：                                                     │
│  ──────────                                                     │
│  最小权限    ─  只给需要的权限，不多一分                        │
│  零信任      ─  永不信任，始终验证                              │
│  职责分离    ─  敏感操作需要多人配合                            │
│  审计监控    ─  所有操作可追溯、可告警                          │
│                                                                 │
│  实施要点：                                                     │
│  ──────────                                                     │
│  临时凭证优先  ─  Assume Role > Access Key                     │
│  MFA 必须      ─  特别是敏感操作                               │
│  条件限制      ─  IP、时间、设备等                             │
│  定期审查      ─  权限会腐化，需要持续清理                      │
│                                                                 │
│  架构层面：                                                     │
│  ──────────                                                     │
│  多账号隔离    ─  环境分离、风险隔离                           │
│  SCP 兜底      ─  组织级别的权限天花板                         │
│  集中身份      ─  IAM Identity Center 统一管理                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> **核心洞见：安全不是一次性配置，而是持续的过程。最佳实践的本质是在"安全性"和"便利性"之间找到平衡，并通过审计和监控确保这个平衡持续有效。**

---

## 思考题

1. 如果发现 CloudTrail 被攻击者关闭了，你该如何检测和恢复？
2. 设计一个方案：允许外包团队临时访问开发环境，但 30 天后自动撤销。
3. 如何在不影响业务的情况下，将一个拥有 Admin 权限的 Role 收紧到最小权限？
